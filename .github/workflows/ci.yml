name: STREAM CI
on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]
  release:
    types: [published]

# Cancel in-progress runs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  # ── Lint ──────────────────────────────────────────────────────────────────
  lint:
    name: Nextflow config lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: nf-core/setup-nextflow@v2
        with:
          version: "latest-stable"

      - name: Validate pipeline syntax
        run: nextflow run main.nf -preview --help || true

  # ── Dry-run (stub) ───────────────────────────────────────────────────────
  stub:
    name: Stub run
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: nf-core/setup-nextflow@v2
        with:
          version: "latest-stable"

      - name: Stub run (no data)
        run: |
          nextflow run main.nf \
            --fastq_dir false \
            --outdir stub_results \
            --run_salmon false \
            --skip_fastqc true \
            -stub-run \
            -profile test \
          || true

  # ── Mini test with real data ─────────────────────────────────────────────
  test:
    name: Test (mini dataset)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: nf-core/setup-nextflow@v2
        with:
          version: "latest-stable"

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq fastqc pigz seqtk
          # fastp
          wget -q https://github.com/OpenGene/fastp/releases/download/v0.23.4/fastp -O /usr/local/bin/fastp && chmod +x /usr/local/bin/fastp
          # multiqc
          pip install --quiet multiqc

      - name: Create mini test FASTQs
        run: |
          mkdir -p test_fastqs
          # Generate tiny synthetic PE reads (1000 reads each)
          python3 -c "
          import gzip, random, os
          random.seed(42)
          bases = 'ACGT'
          for sample in ['testA', 'testB']:
              for read in ['R1', 'R2']:
                  fn = f'test_fastqs/{sample}_{read}_001.fastq.gz'
                  with gzip.open(fn, 'wt') as f:
                      for i in range(1000):
                          seq = ''.join(random.choice(bases) for _ in range(100))
                          qual = 'I' * 100
                          f.write(f'@{sample}_{read}_{i}\n{seq}\n+\n{qual}\n')
          "

      - name: Run STREAM
        run: |
          nextflow run main.nf \
            --fastq_dir test_fastqs \
            --outdir test_results \
            --run_salmon false \
            --run_fastq_screen false \
            --run_kraken2 false \
            -profile test \
            -resume

      - name: Check output
        run: |
          echo "── Output tree ──"
          find test_results -type f | head -50
          echo ""
          echo "── MultiQC report ──"
          ls -lh test_results/08_multiqc/ || echo "No MultiQC output"

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test_results/
          retention-days: 7
