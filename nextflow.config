/*
 * ══════════════════════════════════════════════════════════════════════════════
 *  STREAM — nextflow.config
 *  Optimisé pour exécution locale (Mac Studio)
 * ══════════════════════════════════════════════════════════════════════════════
 */

// ── Paramètres ──────────────────────────────────────────────────────────────

params {

    // ── Input (un seul requis) ──────────────────────────────────────────────
    input               = null          // Samplesheet CSV : sample,fastq_1,fastq_2
    fastq_dir           = null          // Dossier contenant *_R{1,2}_001.fastq.gz
    sra_ids             = null          // Accessions SRA/GEO (CSV ou fichier, 1 par ligne)

    // ── Output ──────────────────────────────────────────────────────────────
    outdir              = 'results'

    // ── Référence (Salmon) ──────────────────────────────────────────────────
    transcriptome_fasta = null          // FASTA transcriptome pré-téléchargé
    salmon_index        = null          // Index Salmon pré-construit (dossier)
    genome              = 'GRCh38'      // Assemblage génomique
    ensembl_release     = 115           // Version Ensembl

    // ── FastQ Screen ────────────────────────────────────────────────────────
    fastq_screen_conf   = null          // Chemin vers fastq_screen.conf

    // ── Kraken2 ─────────────────────────────────────────────────────────────
    kraken2_db          = null          // Chemin vers la base Kraken2

    // ── fastp ───────────────────────────────────────────────────────────────
    fastp_qualified_quality = 20        // Score Phred minimum
    fastp_length_required   = 20        // Longueur minimum après trimming

    // ── Flags de contrôle ───────────────────────────────────────────────────
    run_salmon          = true          // Activer quantification Salmon
    run_fastq_screen    = false         // Activer contamination screening
    run_kraken2         = false         // Activer classification taxonomique
    skip_fastqc         = false         // Désactiver FastQC (raw + clean)
    save_trimmed        = false         // Publier les FASTQs trimmés
    subset_size         = 0             // FastQ Screen: 0 = tous les reads

    // ── Ressources ──────────────────────────────────────────────────────────
    max_cpus            = Runtime.runtime.availableProcessors()
    max_memory          = '64 GB'
}


// ── Ressources par label ────────────────────────────────────────────────────

process {

    errorStrategy = 'retry'
    maxRetries    = 1

    withLabel: 'process_low' {
        cpus   = 2
        memory = '4 GB'
    }

    withLabel: 'process_medium' {
        cpus   = { Math.min(4, params.max_cpus as int) }
        memory = '8 GB'
    }

    withLabel: 'process_high' {
        cpus   = { params.max_cpus }
        memory = '16 GB'
    }

    // Overrides spécifiques
    withName: 'SALMON_INDEX' {
        memory = '32 GB'
    }
}


// ── Profils ─────────────────────────────────────────────────────────────────

profiles {

    standard {
        process.executor = 'local'
    }

    // Profil test minimal (CI / validation rapide)
    test {
        params {
            max_cpus    = 4
            max_memory  = '8 GB'
            run_salmon  = false
            skip_fastqc = false
        }
    }
}


// ── Rapports Nextflow ───────────────────────────────────────────────────────

def trace_timestamp = new java.text.SimpleDateFormat("yyyy-MM-dd_HH-mm-ss").format(new java.util.Date())

timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/timeline_${trace_timestamp}.html"
}

report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/report_${trace_timestamp}.html"
}

trace {
    enabled = true
    file    = "${params.outdir}/pipeline_info/trace_${trace_timestamp}.txt"
}

dag {
    enabled = true
    file    = "${params.outdir}/pipeline_info/dag_${trace_timestamp}.html"
}


// ── Manifest ────────────────────────────────────────────────────────────────

manifest {
    name            = 'BIPN/STREAM'
    author          = 'BIPN'
    description     = 'STREAM — Streamlined Transcript Expression & RNA-seq Mapping'
    version         = '1.0.0'
    nextflowVersion = '>=23.04.0'
    mainScript      = 'main.nf'
}
