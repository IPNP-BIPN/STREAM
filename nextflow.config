/*
 * ══════════════════════════════════════════════════════════════════════════════
 *  STREAM — nextflow.config
 *  Optimized for local execution (Mac Studio / workstation)
 * ══════════════════════════════════════════════════════════════════════════════
 */

// ── Parameters ──────────────────────────────────────────────────────────────

params {

    // ── Input (one required) ────────────────────────────────────────────────
    input               = null          // Samplesheet CSV: sample,fastq_1,fastq_2
    fastq_dir           = null          // Directory containing *_R{1,2}_001.fastq.gz
    sra_ids             = null          // SRA/GEO accessions (csv string or file, 1/line)

    // ── Output ──────────────────────────────────────────────────────────────
    outdir              = 'results'

    // ── Species & Reference ─────────────────────────────────────────────────
    species             = 'human'       // human | mouse | rat | zebrafish | drosophila | c_elegans
    genome              = null          // Override assembly (auto-resolved from species if null)
    ensembl_release     = 115           // Ensembl release version
    transcriptome_fasta = null          // Pre-downloaded transcriptome FASTA (skips download)
    salmon_index        = null          // Pre-built Salmon index directory (skips build)

    // ── FastQ Screen ────────────────────────────────────────────────────────
    fastq_screen_conf   = null          // Path to fastq_screen.conf

    // ── Kraken2 ─────────────────────────────────────────────────────────────
    kraken2_db          = null          // Path to Kraken2 database

    // ── fastp ───────────────────────────────────────────────────────────────
    fastp_qualified_quality = 20        // Minimum Phred quality score
    fastp_length_required   = 20        // Minimum read length after trimming

    // ── Feature flags ───────────────────────────────────────────────────────
    run_salmon          = true          // Enable Salmon quantification
    run_fastq_screen    = false         // Enable contamination screening
    run_kraken2         = false         // Enable taxonomic classification
    skip_fastqc         = false         // Disable FastQC (raw + clean)
    save_trimmed        = false         // Publish trimmed FASTQs to outdir
    subset_size         = 0             // FastQ Screen: 0 = all reads

    // ── Resources ───────────────────────────────────────────────────────────
    // Set --max_memory to match your machine (e.g. '128 GB' for a big server)
    max_cpus            = Runtime.runtime.availableProcessors()
    max_memory          = '64 GB'
}


// ── Per-label resource allocation ───────────────────────────────────────────

process {

    errorStrategy = 'retry'
    maxRetries    = 1

    // Memory scales with --max_memory (default: 64 GB)
    // e.g. --max_memory '128 GB' → process_high gets 32 GB, SALMON_INDEX gets 64 GB
    // Fractions of max_memory:  low=6%, medium=12%, high=25%, salmon_index=50%
    withLabel: 'process_low' {
        cpus   = 2
        memory = { "${Math.max(2, (params.max_memory.replace(' GB','') as int) * 6 / 100)} GB" }
    }

    withLabel: 'process_medium' {
        cpus   = { Math.min(4, params.max_cpus as int) }
        memory = { "${Math.max(4, (params.max_memory.replace(' GB','') as int) * 12 / 100)} GB" }
    }

    withLabel: 'process_high' {
        cpus   = { params.max_cpus }
        memory = { "${Math.max(8, (params.max_memory.replace(' GB','') as int) * 25 / 100)} GB" }
    }

    // Salmon indexing needs more memory for large transcriptomes
    withName: 'SALMON_INDEX' {
        memory = { "${Math.max(16, (params.max_memory.replace(' GB','') as int) * 50 / 100)} GB" }
    }
}


// ── Profiles ────────────────────────────────────────────────────────────────

profiles {

    standard {
        process.executor = 'local'
    }

    // Minimal test profile (CI / quick validation)
    test {
        params {
            max_cpus    = 2
            run_salmon  = false
            skip_fastqc = false
        }
        process {
            withLabel: 'process_low'    { memory = '2 GB' }
            withLabel: 'process_medium' { memory = '4 GB'; cpus = 2 }
            withLabel: 'process_high'   { memory = '6 GB'; cpus = 2 }
            withName:  'SALMON_INDEX'   { memory = '6 GB' }
        }
    }
}


// ── Nextflow reports ────────────────────────────────────────────────────────

def trace_timestamp = new java.text.SimpleDateFormat("yyyy-MM-dd_HH-mm-ss").format(new java.util.Date())

timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/timeline_${trace_timestamp}.html"
}

report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/report_${trace_timestamp}.html"
}

trace {
    enabled = true
    file    = "${params.outdir}/pipeline_info/trace_${trace_timestamp}.txt"
}

dag {
    enabled = true
    file    = "${params.outdir}/pipeline_info/dag_${trace_timestamp}.html"
}


// ── Manifest ────────────────────────────────────────────────────────────────
// Pipeline metadata — used by `nextflow run IPNP-BIPN/STREAM`

manifest {
    name            = 'IPNP-BIPN/STREAM'
    author          = 'BIPN'
    description     = 'STREAM — Streamlined Transcript Expression & RNA-seq Mapping'
    version         = '1.0.0'
    nextflowVersion = '>=23.04.0'
    mainScript      = 'main.nf'
}
